name: çµ±åˆCI/CD

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - "docs/**"
  pull_request:
    branches: [main, master]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œ

env:
  DENO_VERSION: 2.2.3
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  # ãƒ†ã‚¹ãƒˆç’°å¢ƒç”¨ã®å…±é€šè¨­å®š
  TEST_DB_USER: test_user
  TEST_DB_PASSWORD: test_password
  TEST_DB_NAME: test_db
  TEST_BACKEND_PORT: 3000
  TEST_FRONTEND_PORT: 5173

jobs:
  lint-and-format:
    name: ãƒªãƒ³ãƒˆã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®æ¨©é™è¨­å®š
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Docker Buildx ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/backend.Dockerfile
          load: true
          tags: serverless-backend:ci
          target: dev
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/frontend.Dockerfile
          load: true
          tags: serverless-frontend:ci
          target: dev
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ€é©åŒ–
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: ãƒªãƒ³ãƒˆï¼†ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Ÿè¡Œ
        run: |
          echo "::group::ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒªãƒ³ãƒˆ"
          docker run --rm serverless-backend:ci deno lint --ignore=node_modules/,npm:/,/app/.cache/ --json > backend-lint.json || true
          echo "::endgroup::"

          echo "::group::ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒªãƒ³ãƒˆ"
          docker run --rm serverless-frontend:ci deno lint --ignore=node_modules/,npm:/,/app/.cache/ --json > frontend-lint.json || true
          # ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒªãƒ³ãƒˆçµæœã®JSONå½¢å¼ã‚’ç¢ºèª
          echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒªãƒ³ãƒˆçµæœã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèª:"
          cat frontend-lint.json | jq 'type' || true
          echo "æœ€åˆã®æ•°è¡Œã‚’è¡¨ç¤º:"
          cat frontend-lint.json | head -10 || true
          echo "::endgroup::"

          echo "::group::ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
          docker run --rm -v $(pwd):/workspace -w /workspace serverless-backend:ci deno fmt backend/ shared/ --ignore=node_modules/,npm:/,.cache/
          echo "::notice::ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¾ã—ãŸ"
          echo "::endgroup::"

          echo "::group::ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
          docker run --rm -v $(pwd):/workspace -w /workspace serverless-frontend:ci deno fmt frontend/ shared/ --ignore=node_modules/,npm:/,.cache/
          echo "::notice::ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¾ã—ãŸ"
          echo "::endgroup::"

      - name: å¤‰æ›´ã®ç¢ºèª
        id: check-changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # å¤‰æ›´ãŒã‚ã‚‹ã‹ã©ã†ã‹ç¢ºèª
          git add .
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "::notice::ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã‚ˆã‚Šå¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "::notice::ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã‚ˆã‚‹å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: steps.check-changes.outputs.changes == 'true' && github.event_name == 'pull_request'
        run: |
          git commit -m "ğŸ¤– è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé©ç”¨" -m "GitHub Actionsã«ã‚ˆã‚‹è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
          git push
          echo "::notice::ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•çš„ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã€å¤‰æ›´ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã—ãŸ"

      - name: ãƒªãƒ³ãƒˆçµæœç¢ºèª
        id: lint-check
        run: |
          lint_errors=false

          if [ -f backend-lint.json ] && [ -s backend-lint.json ]; then
            echo "::warning::ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒªãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "ãƒªãƒ³ãƒˆã‚¨ãƒ©ãƒ¼è©³ç´°:"
            cat backend-lint.json | jq -r '.[] | "::error file=\(.file),line=\(.range.start.line),col=\(.range.start.col)::\(.message)"' || true
            lint_errors=true
          else
            echo "::notice::ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒªãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“"
          fi

          if [ -f frontend-lint.json ] && [ -s frontend-lint.json ]; then
            echo "::warning::ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒªãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "ãƒªãƒ³ãƒˆã‚¨ãƒ©ãƒ¼è©³ç´°:"
            cat frontend-lint.json | jq -r 'if type == "array" then .[] else . end | if has("message") then "::error file=\(.file // "unknown"),line=\(.range.start.line // 0),col=\(.range.start.col // 0)::\(.message)" else empty end' || true
            lint_errors=true
          else
            echo "::notice::ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒªãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“"
          fi

          echo "lintErrors=$lint_errors" >> $GITHUB_OUTPUT

      - name: ãƒªãƒ³ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: steps.lint-check.outputs.lintErrors == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: |
            backend-lint.json
            frontend-lint.json
          retention-days: 7

  create-compose-configs:
    name: Docker Composeè¨­å®šç”Ÿæˆ
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      compose-ci-file: docker-compose.ci.yml
      compose-e2e-file: docker-compose.e2e.yml
    steps:
      - name: å…±é€šè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        id: create-base-config
        run: |
          cat > docker-compose.base.yml << EOF
          version: '3.8'

          services:
            db:
              build:
                context: ./docker
                dockerfile: db.Dockerfile
              environment:
                - POSTGRES_USER=${{ env.TEST_DB_USER }}
                - POSTGRES_PASSWORD=${{ env.TEST_DB_PASSWORD }}
                - POSTGRES_DB=${{ env.TEST_DB_NAME }}
              tmpfs:
                - /var/lib/postgresql/data
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U ${{ env.TEST_DB_USER }}"]
                interval: 5s
                timeout: 5s
                retries: 5
                start_period: 5s
                
          volumes:
            backend-deno-cache:
            frontend-deno-cache:
          EOF

          echo "::notice::å…±é€šDocker Composeè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"

      - name: ãƒ†ã‚¹ãƒˆç”¨Docker Composeè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        run: |
          cat > docker-compose.ci.yml << EOF
          version: '3.8'

          services:
            backend:
              build:
                context: .
                dockerfile: docker/backend.Dockerfile
                target: dev
              environment:
                - ENV=test
                - PORT=${{ env.TEST_BACKEND_PORT }}
                - DB_HOST=db
                - DB_PORT=5432
                - DB_USER=${{ env.TEST_DB_USER }}
                - DB_PASSWORD=${{ env.TEST_DB_PASSWORD }}
                - DB_NAME=${{ env.TEST_DB_NAME }}
              volumes:
                - ./backend:/app
                - ./shared:/app/shared
                - backend-deno-cache:/app/.cache
              depends_on:
                db:
                  condition: service_healthy
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:${{ env.TEST_BACKEND_PORT }}/health"]
                interval: 5s
                timeout: 5s
                retries: 3
                start_period: 5s
            
            frontend:
              build:
                context: .
                dockerfile: docker/frontend.Dockerfile
                target: dev
              environment:
                - ENV=test
                - VITE_API_URL=http://backend:${{ env.TEST_BACKEND_PORT }}
              volumes:
                - ./frontend:/app
                - ./shared:/app/shared
                - frontend-deno-cache:/app/.cache
              depends_on:
                backend:
                  condition: service_healthy
            
            db:
              extends:
                file: docker-compose.base.yml
                service: db

          volumes:
            backend-deno-cache:
            frontend-deno-cache:
          EOF

          echo "::notice::ãƒ†ã‚¹ãƒˆç”¨Docker Composeè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"

      - name: E2Eãƒ†ã‚¹ãƒˆç”¨Docker Composeè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        run: |
          cat > docker-compose.e2e.yml << EOF
          version: '3.8'

          services:
            backend:
              build:
                context: .
                dockerfile: docker/backend.Dockerfile
                target: dev
              environment:
                - ENV=test
                - PORT=${{ env.TEST_BACKEND_PORT }}
                - DB_HOST=db
                - DB_USER=${{ env.TEST_DB_USER }}
                - DB_PASSWORD=${{ env.TEST_DB_PASSWORD }}
                - DB_NAME=${{ env.TEST_DB_NAME }}
              volumes:
                - ./backend:/app
                - ./shared:/app/shared
                - backend-deno-cache:/app/.cache
              depends_on:
                db:
                  condition: service_healthy
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:${{ env.TEST_BACKEND_PORT }}/health"]
                interval: 5s
                timeout: 5s
                retries: 3
                start_period: 5s
                
            frontend:
              build:
                context: .
                dockerfile: docker/frontend.Dockerfile
                target: dev
              environment:
                - ENV=test
                - VITE_API_URL=http://backend:${{ env.TEST_BACKEND_PORT }}
              ports:
                - "${{ env.TEST_FRONTEND_PORT }}:${{ env.TEST_FRONTEND_PORT }}"
              volumes:
                - ./frontend:/app
                - ./shared:/app/shared
                - frontend-deno-cache:/app/.cache
              depends_on:
                backend:
                  condition: service_healthy
                  
            e2e:
              build:
                context: .
                dockerfile: docker/frontend.Dockerfile
                target: dev
              volumes:
                - ./frontend:/app
                - ./shared:/app/shared
                - ./frontend/playwright-report:/app/playwright-report
                - ./frontend/test-results:/app/test-results
              environment:
                - PLAYWRIGHT_BASE_URL=http://frontend:${{ env.TEST_FRONTEND_PORT }}
              depends_on:
                frontend:
                  condition: service_started
              command: ["task", "test:e2e"]
            
            db:
              extends:
                file: docker-compose.base.yml
                service: db
                
          volumes:
            backend-deno-cache:
            frontend-deno-cache:
          EOF

          echo "::notice::E2Eãƒ†ã‚¹ãƒˆç”¨Docker Composeè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"

      - name: Composeè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: compose-configs
          path: |
            docker-compose.base.yml
            docker-compose.ci.yml
            docker-compose.e2e.yml
          retention-days: 1

  unit-tests:
    name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint-and-format, create-compose-configs]
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Docker Compose ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: KengoTODA/actions-setup-docker-compose@main
        with:
          version: "2.21.0"

      - name: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Composeè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: compose-configs

      - name: Docker Compose ãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹ç¯‰
        run: docker-compose -f docker-compose.ci.yml build

      - name: DBèµ·å‹•
        run: docker-compose -f docker-compose.ci.yml up -d db

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èµ·å‹•
        run: docker-compose -f docker-compose.ci.yml up -d backend

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: docker-compose -f docker-compose.ci.yml exec -T backend deno task test:unit

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: docker-compose -f docker-compose.ci.yml exec -T backend deno task test:integration

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰èµ·å‹•
        run: docker-compose -f docker-compose.ci.yml up -d frontend

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: docker-compose -f docker-compose.ci.yml exec -T frontend deno task test:unit

      - name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç”Ÿæˆï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰
        run: |
          mkdir -p coverage/backend
          docker-compose -f docker-compose.ci.yml exec -T backend deno task coverage
          docker cp $(docker-compose -f docker-compose.ci.yml ps -q backend):/app/coverage/. coverage/backend

      - name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç”Ÿæˆï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
        run: |
          mkdir -p coverage/frontend
          docker-compose -f docker-compose.ci.yml exec -T frontend deno task coverage
          docker cp $(docker-compose -f docker-compose.ci.yml ps -q frontend):/app/coverage/. coverage/frontend

      - name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage
          path: coverage/
          retention-days: 7

      - name: ç’°å¢ƒåœæ­¢
        if: always()
        run: docker-compose -f docker-compose.ci.yml down -v

  e2e-test:
    name: E2Eãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [unit-tests, create-compose-configs]
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Docker Compose ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: KengoTODA/actions-setup-docker-compose@main
        with:
          version: "2.21.0"

      - name: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Composeè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: compose-configs

      - name: Docker Compose E2Eç’°å¢ƒæ§‹ç¯‰
        run: docker-compose -f docker-compose.e2e.yml build

      - name: Playwrightã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆE2Eã‚³ãƒ³ãƒ†ãƒŠå†…ï¼‰
        run: docker-compose -f docker-compose.e2e.yml run --rm e2e deno run -A npm:playwright@latest install --with-deps chromium

      - name: E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          # DB, ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•
          docker-compose -f docker-compose.e2e.yml up -d db backend frontend

          # ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
          echo "ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
          sleep 20

          # E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          docker-compose -f docker-compose.e2e.yml run --rm e2e deno task test:e2e

      - name: E2Eãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 14

      - name: ç’°å¢ƒåœæ­¢
        if: always()
        run: docker-compose -f docker-compose.e2e.yml down -v

  build:
    name: æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: e2e-test
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Docker Buildx ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      - name: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æœ¬ç•ªã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/backend.Dockerfile
          load: true
          tags: serverless-backend:prod
          target: prod
          build-args: |
            DENO_ENV=production
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æœ¬ç•ªã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/frontend.Dockerfile
          load: true
          tags: serverless-frontend:prod
          target: prod
          build-args: |
            DENO_ENV=production
            VITE_API_URL=https://api.example.com
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ€é©åŒ–
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®æŠ½å‡ºï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰
        run: |
          mkdir -p build/backend
          docker create --name backend-container serverless-backend:prod
          docker cp backend-container:/app/dist/. build/backend/
          docker rm backend-container

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®æŠ½å‡ºï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
        run: |
          mkdir -p build/frontend
          docker create --name frontend-container serverless-frontend:prod
          docker cp frontend-container:/app/build/. build/frontend/
          docker rm frontend-container

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/
          retention-days: 7

      - name: ã‚³ãƒ³ãƒ†ãƒŠã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          docker rm -f backend-container frontend-container 2>/dev/null || true
          docker image prune -f

  deploy:
    name: ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./dist

      - name: AWSèªè¨¼è¨­å®š
        if: false # å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã™
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deno Deployæº–å‚™
        if: false # å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã™
        uses: denoland/setup-deno@v2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™
        run: echo "ãƒ‡ãƒ—ãƒ­ã‚¤ã®æº–å‚™ã‚’ã—ã¦ã„ã¾ã™..."

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
        if: false # å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã™
        run: |
          echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’æœ¬ç•ªç’°å¢ƒã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã¾ã™..."
          # Deno Deployã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆ
          # deno run -A https://deno.land/x/deploy/deployctl.ts deploy --project=your-frontend-project ./dist/frontend/index.js
          # ã¾ãŸã¯ AWS S3/CloudFrontã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆ
          # aws s3 sync ./dist/frontend s3://${{ secrets.FRONTEND_BUCKET_NAME }} --delete
          # aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
        if: false # å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã™
        run: |
          echo "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’æœ¬ç•ªç’°å¢ƒã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã¾ã™..."
          # Deno Deployã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆ
          # deno run -A https://deno.land/x/deploy/deployctl.ts deploy --project=your-backend-project ./dist/backend/main.js
          # ã¾ãŸã¯ AWS Lambdaã‚„ä»–ã®ã‚µãƒ¼ãƒãƒ¬ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰
          # aws lambda update-function-code --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} --zip-file fileb://dist/backend/function.zip

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
        run: echo "ãƒ†ã‚¹ãƒˆç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
